<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="com.holoyolo.app.club.mapper.ClubMapper">

	<select id="getClub" resultType="ClubVO">
		SELECT * 
		FROM club 
		WHERE club_id = #{clubId}
	</select>
  
  	<select id="selectClubAll" resultType="ClubVO">
  		
  		<!-- 모임성공횟수, 가입자수 추후 추가 -->
		SELECT club_id, club_name, club_leader, club_people, club_date,
		    CASE 
		        WHEN open_scope = 'OA1' THEN '공개'
		        WHEN open_scope = 'OA2' THEN '비공개'
		        END AS open_scope
		FROM club
		ORDER BY club_id
  		
  	</select>
  

  	
  	<select id="getAllClubList" resultType="ClubVO">
  		SELECT c.*, m.nickname as leader_name
  		FROM club c join member m on c.club_leader = m.member_id
  		ORDER BY club_id
  	</select>
  	
  
  	<!-- 알뜰모임 목록리스트 -->
  	<select id="getClubList" resultType="ClubVO">

            SELECT * 
    		FROM (
       			SELECT rownum rn, a.*
        		FROM ( 
            		
            		<if test="search != null or search != ''">
                		<if test="searchTitle == 'clubname'">
                		SELECT c.*, m.nickname as leader_name
                    	FROM club c join member m on c.club_leader = m.member_id
                    	WHERE club_name LIKE '%'||#{search}||'%'
                		</if>
	                	<if test="searchTitle == 'clubking'">
	                    	SELECT *
	                    	FROM (
		                        SELECT c.*, m.nickname as leader_name
		                        FROM club c 
		                        JOIN member m ON c.club_leader = m.member_id
		                        WHERE m.nickname LIKE '%'||#{search}||'%'
	                    	)
	                	</if>
            		</if>
		            <if test="search == null or search == ''">
		            SELECT c.*, m.nickname as leader_name
		            FROM club c join member m on c.club_leader = m.member_id
		            </if>
           			ORDER BY club_id
        		) A
        		<![CDATA[
        		WHERE rownum <= #{page} * 6
    		) b
    		WHERE b.rn > (#{page} - 1) * 6
			]]>
  	</select>
  	
  	<!-- 검색 시 데이터 총 갯수 -->
  	<select id="cntData" parameterType="ClubVO" resultType="int">
    SELECT COUNT(*) 
        <if test="search != null or search != ''">
            <if test="searchTitle == 'clubname'">
                FROM club
                WHERE club_name LIKE '%'||#{search}||'%'
            </if>
            <if test="searchTitle == 'clubking'">
                FROM
                (SELECT c.*, m.nickname
                 FROM club c
                 JOIN member m ON c.club_leader = m.member_id
                 WHERE m.nickname LIKE '%'||#{search}||'%')
            </if>
         </if>
        <if test="search == null or search == ''">
            FROM club
        </if>
  		
  	</select>
  	
  	<insert id="insertClub" parameterType="ClubVO">
  	  	<selectKey keyProperty="clubId"
					   resultType="int"
					   order="BEFORE">
	  		    SELECT NVL(MAX(club_id),0) + 1
				FROM club
	  	</selectKey>
  		INSERT into club 
  		VALUES 
  			(
  				#{clubId}
  				,#{clubName} 
  				,#{clubIntro}
  				,#{clubProfileImg}
  				,#{clubPeople}
  				,#{joinCondition}
  				,#{openScope}
  				,null
  				,#{clubLeader}
  				,sysdate
  			)
  	</insert>

  </mapper>