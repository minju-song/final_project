<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org/" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout/layout}">

<head>
    <meta charset="UTF-8">
    <title>Insert title here</title>
    <style>
        .chatBox {
            /* border: 1px solid black; */
            border-radius: 20px;
            padding: 20px;
            margin: 10px;
            box-shadow: rgba(0, 0, 0, 0.24) 0px 3px 8px;
        }

        .not {
            border-radius: 10px;
            padding-left: 5px;
            padding-right: 5px;
            background-color: red;
            color: white;
            font-size: small;
        }
    </style>
</head>

<body>
    <div layout:fragment="content">
        <h3>중고거래 채팅목록</h3>
        <div class="chatBox" th:each="chatting : ${result.list}" style="display: flex;">
            <div style="flex: 1; display: flex; justify-content: center;">
                <!-- <h3>[[${chatting.you.nickname}]]</h3> -->
                <img th:src="@{/images/}+${chatting.you.profileImg}" alt="..." style="width: 100px; height: 100px;object-fit: cover; border-radius: 50px;">
            </div>
            <div th:id="${chatting.tradeId}" style="flex: 7;"
                th:onclick="|location.href='@{/member/tradeChat(sellerId=${chatting.sellerId},tradeId=${chatting.tradeId})}'|">
                <h3>[[${chatting.you.nickname}]] <span style="font-size: small;" th:text="${#dates.format(chatting.lastChatTime, 'yyyy-MM-dd hh:mm')}"></span> 
                    <span class="not">  [[${chatting.notread}]]</span></h3>
                <h4 class="lastchat">&#128140;[[${chatting.lastchat}]]</h4>
                <h4>거래명 : [[${chatting.title}]]</h4>
                <th:block th:if="${#authentication.Principal.memberVO.memberId eq chatting.buyerId}">
                    <h5 style="color: red;">구매</h5>
                </th:block>
                <th:block th:if="${#authentication.Principal.memberVO.memberId eq chatting.sellerId}">
                    <h5 style="color: red;">판매</h5>
                </th:block>
                
            </div>
        </div>

        <script th:inline="javascript">
            let list = /*[[${result.list}]]*/ null;

        </script>

        <script>
            console.log(list);

            let ws;
            let test = document.getElementById('test')


            $(document).ready(function () {
                // console.log(memberId);

                for (let i = 0; i < list.length; i++) {
                    ws = new WebSocket("ws://" + location.host + "/tradeChat?tradeId=" + list[i].tradeId);

                    ws.onmessage = function (msg) {
                        let data = JSON.parse(msg.data);
                        console.log(data);

                        // document.getElementById(data.tradeId).querySelector('.not')
                        let notread = document.getElementById(data.tradeId).querySelector('.not')
                        let last = document.getElementById(data.tradeId).querySelector('.lastchat');
                        console.log(notread);
                        notread.innerText = Number(notread.innerText) + 1;
                        last.innerText = data.msg;
                    }
                }
                //소켓생성


                //메시지수신
            });
        </script>
    </div>
</body>

</html>