<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org/"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/layout}">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<link th:href="@{/user/css/trade.css}" rel="stylesheet" type="text/css">
<!-- 소스 다운 -->
<script src="https://unpkg.com/@yaireo/tagify"></script>
<!-- 폴리필 (구버젼 브라우저 지원) -->
<script src="https://unpkg.com/@yaireo/tagify/dist/tagify.polyfills.min.js"></script>
<link href="https://unpkg.com/@yaireo/tagify/dist/tagify.css" rel="stylesheet" type="text/css" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
</head>
<body>
	<div layout:fragment="content">
		<div class="container">
			<div class="row centerwrap">
				<!-- 사진 슬라이더 -->
				<div id="carouselExampleControlsNoTouching" class="carousel slide" data-touch="false" data-interval="false">
				  <div class="carousel-inner">
				    <div class="carousel-item" th:classappend="${trade.attachmentSeq == 1} ? 'active' : ''" th:each="trade, stat : ${tradeImg}">
				      <img th:src="@{/images/}+ ${trade.saveFile}" class="d-block w-100" alt="...">
				    </div>
				  </div>
				  <button class="carousel-control-prev" type="button" data-target="#carouselExampleControlsNoTouching" data-slide="prev" th:if="${tradeImg.size > 1}">
				    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
				    <span class="sr-only">Previous</span>
				  </button>
				  <button class="carousel-control-next" type="button" data-target="#carouselExampleControlsNoTouching" data-slide="next" th:if="${tradeImg.size > 1}">
				    <span class="carousel-control-next-icon" aria-hidden="true"></span>
				    <span class="sr-only">Next</span>
				  </button>
				  <img class="_heart" id="heart" th:src="@{/user/images/trade/bin-heart.png}" th:if="${heartInfo == null}">
				  <img class="_heart bi-heart" id="heart" th:src="@{/user/images/trade/fill-heart.png}" th:if="${heartInfo != null}">
				</div>
				<!-- 상품정보 -->
				<div class="col-lg-6">
					<div class="product_content">
						<div class="row watchwrap bottomdown10">
							<div class="row">
								<div class="heartCount silverColor" th:text="|관심 ${heartCount.heartCount}|"></div>
								<div class="reviewCount silverColor" th:text="| │ 조회수 ${tradeInfo.views} │ ${#dates.format(tradeInfo.writeDate, 'yyyy-MM-dd')}|"></div>
							</div>
							<div class="row" th:if="${memberId != tradeInfo.sellerId}">
								<div class="report silverColor">신고하기</div>
							</div>
						</div>
						<div class="row">
							<div class="tradeType bottomdown10"><p th:text="${tradeInfo.tradeType}"></p></div>
							<div class="tradeTitle bottomdown" th:text="${tradeInfo.title}"></div>
						</div>
						<div class="tradeCategory bottomdown10">
							<span th:text="|카테고리 : ${tradeInfo.tradeCategory}|"></span>
						</div>
						<div class="row bottomwrap watchwrap">
							<div class="tradePrice">
								<p th:text="|${#numbers.formatInteger(tradeInfo.price, 0, 'COMMA')}원|" th:if="${tradeInfo.price != 0}"></p>
								<p th:text="무료나눔" th:if="${tradeInfo.price == 0}" th:style="@{color:#ff6868;}"></p>
							</div>
							<!-- 판매자 버튼 -->
							<div th:if="${memberId == tradeInfo.sellerId}">
								<div class="pay insertbutton">
									<p>약속취소</p>
								</div>
								<div class="pay insertbutton" th:if="${tradeInfo.paymentType == 'TC2'}">
									<p>약속확정</p>
									
								</div>
							</div>
							<!-- 구매자 버튼 -->
							<div th:if="${memberId != tradeInfo.sellerId}">
								<div class="pay insertbutton">
									<p>약속잡기</p>
								</div>
								<div class="pay insertbutton" th:if="${tradeInfo.paymentType == 'TC2'}">
									<p><img class="holoPay" id="holoPay" th:src="@{/user/images/trade/piggy-bank.svg}"> 홀로페이</p>
									
								</div>
							</div>
						</div>
					</div>
				</div>
			</div><hr>
			<div class="row bottomdown10 margins">
				<img th:src="@{/images/}+ ${tradeInfo.profileImg}" alt="Profile" class="rounded-circle" th:if="${tradeInfo.profileImg != null}">
				<img th:src="@{/user/images/trade/user.png}" alt="Profile" class="rounded-circle" th:if="${tradeInfo.profileImg == null}">
				<div class="tradeCategory bottomdown">
					<span class="nickName" th:text="${tradeInfo.nickname}"></span>
				</div>
			</div>
			<div class="tradeCategory bottomdown margins" style="margin-bottom: 50px">
				<span th:text="${tradeInfo.description}"></span>
			</div><hr>
			<div class="col-12 bottomdown30">
                <div class="input-group mb-3 openKakao">
	               <span class="input-group-text" id="openKakao">오픈 카카오톡</span>
	               <a class="form-control" th:href="${tradeInfo.openKakao}">[[${tradeInfo.openKakao}]]</a>
	            </div>
            </div>
            <div class="card noneMap" style="display: none;">
	        	<div class="card-body" style="text-align: center;">
	        		<h5 class="card-title">지정된 장소가 없습니다.</h5>
		            <br>등록된 지정 장소가 없어 지도를 표시할 수 없습니다.
	        	</div>
	        </div>
            <div class="bottomdown30" id="map" style="width:100%;height:350px;"></div>
            <div class="col-md-12 writeInput buttonFrom" th:if="${tradeInfo.sellerId == memberId}">
              <button type="button" class="btn btn-secondary" th:onclick="'location.href=\'/member/tradeUpdate?tradeId='+ @{${tradeInfo.tradeId}} + '\''">수정</button>
              <button type="button" class="btn btn-primary tradeDelete" th:onclick="deleteTrade()">삭제</button>
            </div>
        </div>
        <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=41f4363083eed1ec3ebd60c038e1c2b7"></script>
		<script>
			if(`[[${tradeInfo.latitude}]]` != ''){
				let mapContainer = document.getElementById('map'), // 지도를 표시할 div 
				    mapOption = { 
				        center: new kakao.maps.LatLng(`[[${tradeInfo.latitude}]]`, `[[${tradeInfo.longitude}]]`), // 지도의 중심좌표
				        level: 3 // 지도의 확대 레벨
				    };
				
				let map = new kakao.maps.Map(mapContainer, mapOption);
				
				// 마커가 표시될 위치입니다 
				let markerPosition  = new kakao.maps.LatLng(`[[${tradeInfo.latitude}]]`, `[[${tradeInfo.longitude}]]`); 
				
				// 마커를 생성합니다
				let marker = new kakao.maps.Marker({
				    position: markerPosition
				});
				
				// 마커가 지도 위에 표시되도록 설정합니다
				marker.setMap(map);
				
				let iwContent = '<div style="padding:5px;">[[${tradeInfo.tradePlace}]] <br><a href="https://map.kakao.com/link/map/[[${tradeInfo.tradePlace}]],[[${tradeInfo.latitude}]], [[${tradeInfo.longitude}]]" style="color:blue" target="_blank">큰지도보기</a> <a href="https://map.kakao.com/link/to/[[${tradeInfo.tradePlace}]],[[${tradeInfo.latitude}]], [[${tradeInfo.longitude}]]" style="color:blue" target="_blank">길찾기</a></div>', // 인포윈도우에 표출될 내용으로 HTML 문자열이나 document element가 가능합니다
				    iwPosition = new kakao.maps.LatLng(`[[${tradeInfo.latitude}]]`, `[[${tradeInfo.longitude}]]`); //인포윈도우 표시 위치입니다
				
				// 인포윈도우를 생성합니다
				let infowindow = new kakao.maps.InfoWindow({
				    position : iwPosition, 
				    content : iwContent 
				});
				  
				// 마커 위에 인포윈도우를 표시합니다. 두번째 파라미터인 marker를 넣어주지 않으면 지도 위에 표시됩니다
				infowindow.open(map, marker); 
			}else{
				document.querySelector('.noneMap').style.display = 'block';
				document.querySelector('.bottomdown30').style.display = 'none !important';
			}
			
			//중고거래 삭제
			function deleteTrade(){
				let tradeId = [[${tradeInfo.tradeId}]]
				$.ajax({
					url : '/member/tradeDelete',  //이동할 jsp 파일 주소
					data : {tradeId},
					success: function(data){
						Swal.fire({
		                    title: '정말로 그렇게 하시겠습니까?',
		                    text: "다시 되돌릴 수 없습니다. 신중하세요.",
		                    icon: 'warning',
		                    showCancelButton: true,
		                    confirmButtonColor: '#3085d6',
		                    cancelButtonColor: '#d33',
		                    confirmButtonText: '승인',
		                    cancelButtonText: '취소'
		                }).then((result) => {
		                    if (result.isConfirmed) {
		                        Swal.fire(
		                            '중고거래 삭제',
		                            '선택하신 중고거래를 삭제했습니다!',
		                            'success'
		                        )
								document.querySelector('.swal2-confirm').addEventListener('click', function(e){
								   location.href = "/tradeList";
								});
		                    }
		                })
					},
					error:function(){   //데이터 주고받기가 실패했을 경우 실행할 결과
						console.log("중고거래 삭제 실패");
					}
				})
			}
			
			document.getElementById('heart').addEventListener('click', function(e){
				let tradeId = [[${tradeInfo.tradeId}]];
				let heartCount = '';
				if(!e.target.classList.contains('bi-heart')){
					e.target.src = '/user/images/trade/fill-heart.png';
					heartCount = Number(`[[${heartCount.heartCount}]]`) + 1;
					document.querySelector('.heartCount').innerText = '관심 ' + heartCount;
					$.ajax({
						type: 'POST',
						url : '/member/heartInsert',  //이동할 jsp 파일 주소
						data : {tradeId},
						success: function(data){   //데이터 주고받기 성공했을 경우 실행할 결과
							console.log("성공");
						},
						error:function(){   //데이터 주고받기가 실패했을 경우 실행할 결과
							console.log('실패');
						}
					})	
				}else{
					e.target.src = '/user/images/trade/bin-heart.png';
					heartCount = `[[${heartCount.heartCount}]]`;
					document.querySelector('.heartCount').innerText = '관심 ' + heartCount;
					$.ajax({
						url : '/member/heartDelete',  //이동할 jsp 파일 주소
						data : {tradeId},
						success: function(data){   //데이터 주고받기 성공했을 경우 실행할 결과
							console.log("성공");
						},
						error:function(){   //데이터 주고받기가 실패했을 경우 실행할 결과
							console.log("실패");
						}
					})
				}
				e.target.classList.toggle('bi-heart');
			})
		</script>
	</div>
</body>
</html>

