<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org/" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout/layout}">

<head>
    <meta charset="UTF-8">
    <title>Insert title here</title>
    <style>
        #chattingDiv {
            background-color: navy;

            width: 100%;
            height: 500px;
            margin-bottom: 20px;
            padding: 20px;
            overflow-y: auto;
        }

        #sendArea {
            width: 50%;

        }

        .me,
        .other {
            width: 300px;
            /* color: white; */
            font-weight: bold;
            border-radius: 20px;
            padding: 10px;
            color: black;
        }

        .other {
            background-color: white;

        }

        .me {
            background-color: yellow;

        }

        .sender {
            color: white;
        }

        .me_div {
            display: flex;
            justify-content: end;
        }

        .me_div>.box>.sender {
            text-align: end;
        }

        .enter {
            color: white;
            text-align: center;
        }
    </style>
</head>

<body>
    <div layout:fragment="content">
        <p>채팅방</p>
        <div id="chattingDiv">
            <!-- <div class="msg">
                <div class="other">
                    안녕
                </div>
                <p class="sender">수신자</p>
            </div> -->
        </div>
        <textarea id="sendArea"></textarea>
        <button id="sendChat" onclick="sendMsg()">전송</button>

        <script th:inline="javascript">
            let memberId = /*[[${memberId}]]*/ null;
            let memberName = /*[[${memberName}]]*/ null;
            let clubId = /*[[${result.club.clubId}]]*/ null;
            let room = /*[[${room}]]*/ null;
        </script>

        <script>
            console.log(memberName);
            let data = {};

            let ws;
            let sendBtn = document.getElementById('sendChat');
            let msg = document.getElementById('sendArea');
            let chatBox = document.getElementById('chattingDiv');

            chatBox.scrollTop = chatBox.scrollHeight;




            $(document).ready(function () {
                console.log(memberId);
                ws = new WebSocket("ws://" + location.host + "/chat?clubId=" + clubId);

                ws.onmessage = function (msg) {
                    let data = JSON.parse(msg.data);
                    console.log(data);


                    drawChat(data);
                }
            });

            msg.onkeyup = function (e) {
                if (e.keyCode == 13) {
                    send();
                }
            }

            sendBtn.onclick = function () {
                send();
            }

            function send() {
                if (msg.value.trim() != '') {
                    data.memberId = memberId;
                    data.msg = msg.value;
                    data.date = new Date().toLocaleString();
                    data.clubId = clubId;
                    data.memberName = memberName;
                    data.type = 'msg';
                    let temp = JSON.stringify(data);
                    ws.send(temp);
                    console.log(temp);

                    fetch("/member/insertChat", {
                        method: "POST",
                        body: temp,
                        headers: {
                            "Content-Type": "application/json"
                        }
                    })
                        .then(response => response.json())
                        .then(result => {
                            if (result.result == 'success') {
                                console.log('디비저장성공');
                            }
                            else {
                                console.log('디비저장실패');
                            }
                        })

                }

                msg.value = '';
            }

            function drawChat(data) {
                if (data.type == 'msg') {
                    let div = document.createElement('div');


                    let divbox = document.createElement('div');
                    divbox.setAttribute('class', 'box');

                    let div2 = document.createElement('div');


                    div2.innerText = data.msg;

                    let p = document.createElement('p');
                    p.setAttribute('class', 'sender');

                    if (data.memberId == memberId) {
                        div.classList.add('msg', 'me_div');
                        div2.setAttribute('class', 'me');
                        p.innerHTML = '<span style="padding:0 15px;">' + data.date + '</span>' + ' 나';
                    }
                    else {
                        div.classList.add('msg', 'other_div');
                        div2.setAttribute('class', 'other');
                        p.innerHTML = data.memberName + '<span style="padding:0 15px;">' + data.date + '</span>';
                    }

                    divbox.appendChild(div2);
                    divbox.appendChild(p);
                    div.appendChild(divbox);
                    chatBox.appendChild(div);
                }

                else if (data.type == 'enter') {
                    let p = document.createElement('p');
                    p.setAttribute('class', 'enter');
                    p.innerText = data.msg
                    chatBox.appendChild(p);
                }

                chatBox.scrollTop = chatBox.scrollHeight;

            }

        </script>
    </div>
</body>

</html>