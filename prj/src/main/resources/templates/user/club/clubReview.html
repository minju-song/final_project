<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org/" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout/layout}">

<head>
    <meta charset="UTF-8">
    <title>Insert title here</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.js"></script>
    <style>
        .star_rating {
            width: 100%;
            box-sizing: border-box;
            display: inline-flex;
            float: left;
            flex-direction: row;
            justify-content: flex-start;
        }

        .star_rating .star {
            width: 25px;
            height: 25px;
            margin-right: 10px;
            display: inline-block;
            background: url('https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FE2bww%2FbtsviSSBz4Q%2F5UYnwSWgTlFt6CEFZ1L3Q0%2Fimg.png') no-repeat;
            background-size: 100%;
            box-sizing: border-box;
        }

        .star_rating .star.on {
            width: 25px;
            height: 25px;
            margin-right: 10px;
            display: inline-block;
            background: url('https://blog.kakaocdn.net/dn/b2d6gV/btsvbDoal87/XH5b17uLeEJcBP3RV3FyDk/img.png') no-repeat;
            background-size: 100%;
            box-sizing: border-box;
        }

        .star_box {
            width: 400px;
            box-sizing: border-box;
            display: inline-block;
            margin: 15px 0;
            background: #F3F4F8;
            border: 0;
            border-radius: 10px;
            height: 100px;
            resize: none;
            padding: 15px;
            font-size: 13px;
            font-family: sans-serif;
        }

        .btn02 {
            display: block;
            width: 400px;
            font-weight: bold;
            border: 0;
            border-radius: 10px;
            max-height: 50px;
            padding: 15px 0;
            font-size: 1.1em;
            text-align: center;
            background: bisque;
        }

        .divbox {
            padding: 20px;
            margin: 0 auto;
            border-radius: 5px;
            box-shadow: rgba(0, 0, 0, 0.24) 0px 3px 8px;
            border-radius: 20px;
            margin-bottom: 20px;
        }

        .btn {
            border: 0;
            background-color: white;
        }

        .writeDate {
            font-size: smaller;
        }
    </style>
</head>

<body>
    <div layout:fragment="content">

        <h3>[[${result.club.clubName}]] 모임의 리뷰</h3>

        <div class="divbox">
            <h3>리뷰작성공간</h3>
            <div id="writeReview">
                <th:block th:if="${result.myreview == false and session.check eq true}">
                    <div class="star_rating star_on">
                        <span class="star on" value="1"> </span>
                        <span class="star on" value="2"> </span>
                        <span class="star on" value="3"> </span>
                        <span class="star on" value="4"> </span>
                        <span class="star on" value="5"> </span>
                    </div>
                    <input id="writeContents">
                    <button onclick="reviewWrite()">작성</button>
                </th:block>
            </div>
            <div id="completeReview">
                <th:block th:if="${result.myreview == true}">
                    리뷰를 작성하셨습니다.
                </th:block>
            </div>
            <div id="nomemberReview">
                <th:block th:if="${session.check != true}">
                    멤버만 리뷰작성이 가능합니다.
                </th:block>
            </div>
        </div>

        <div class="avg">
            <h4>평균평점
                <div class="star_rating">
                    <span th:if="${result.avgstar != 0}" th:each="i : ${#numbers.sequence(1, result.avgstar)}"
                        class="star on"> </span>

                </div>
            </h4>
            <p>등록된 리뷰 ([[${result.reviews.size()}]])</p>
        </div>

        <div id="reviewlist" class="divbox">
            <th:block th:if="${result.reviews.size == 0}">
                <h4>등록된 리뷰가 없습니다.</h4>
            </th:block>
            <th:block th:if="${result.reviews.size != 0}">
                <hr>
                <th:block th:each="review, stat : ${result.reviews}">
                    <div class="rev">
                        <h4>작성자 : [[${review.nickname}]]</h4>
                        <div th:id="'stars_' + ${review.reviewId}">
                            <div class="star_rating">
                                <span th:each="i : ${#numbers.sequence(1, review.star)}" class="star on"> </span>
                            </div>
                        </div>
                        <span class="writeDate"
                            th:text="${#dates.format(review.writeDate, 'yyyy년 MM월 dd일 HH:mm')}"></span>

                        <div>
                            <h4 th:id="'reviewContent_' + ${review.reviewId}" th:text="${review.contents}"
                                style="display: inline;"></h4>
                            <div th:id="'updateInput_' + ${review.reviewId}" style="display: none;">
                                <input type="text" th:value="${review.contents}" /> <button
                                    th:onclick="'updateReview(\'' + ${review.reviewId} + '\',event)'">수정</button>
                            </div>
                        </div>

                        <th:block th:if="${#authentication.Principal.memberVO.memberId eq review.memberId}">
                            <button class="btn"
                                th:onclick="'toggleUpdateMode(\'' + ${review.reviewId} + '\')'">✔️</button>
                            <button class="btn" th:onclick="'deleteReview(\'' + ${review.reviewId} + '\')'">❌</button>
                        </th:block>
                    </div>
                    <hr>
                    <br>

                </th:block>
            </th:block>
        </div>

        <script th:inline="javascript">
            let clubId = /*[[${ result.club.clubId }]]*/ null;
            let userId = /*[[${ userId }]]*/ null;
            let nickname = /*[[${ user.nickname }]]*/ null;

        </script>

        <script>
            function toggleUpdateMode(id) {
                // index를 정수로 변환
                id = parseInt(id);

                var reviewContent = document.getElementById('reviewContent_' + id);
                var updateInput = document.getElementById('updateInput_' + id);

                if (updateInput.style.display === 'none') {
                    // 수정 모드로 전환
                    reviewContent.style.display = 'none';
                    updateInput.style.display = 'inline';

                    let divid = document.getElementById('stars_' + id);
                    divid.innerHTML = `                    <div class="star_rating star_on">
                        <span class="star on" value="1"> </span>
                        <span class="star on" value="2"> </span>
                        <span class="star on" value="3"> </span>
                        <span class="star on" value="4"> </span>
                        <span class="star on" value="5"> </span>
                    </div>`;

                    $('.star_on > .star').click(function () {
                        $(this).parent().children('span').removeClass('on');
                        $(this).addClass('on').prevAll('span').addClass('on');
                        console.log($(this));
                    })


                } else {
                    // 읽기 모드로 전환
                    reviewContent.style.display = 'inline';
                    updateInput.style.display = 'none';
                }
            }


            $('.star_on > .star').click(function () {
                $(this).parent().children('span').removeClass('on');
                $(this).addClass('on').prevAll('span').addClass('on');
                console.log($(this));
            })

            function reviewWrite() {
                let writeContents = document.getElementById('writeContents').value;
                // console.log(clubId + '에 대한 리뷰 : ' + writeContents);
                let stars = document.querySelectorAll('.star_on > .on');
                let maxStar = 0;
                stars.forEach(function (star, idx) {
                    // console.log(star.getAttribute("value"));
                    if (maxStar < star.getAttribute("value")) {
                        maxStar = star.getAttribute("value");
                    }
                })

                // console.log('평점 : ' + maxStar);
                let data = { star: maxStar, clubId: clubId, contents: writeContents };
                $.ajax({
                    type: 'POST',
                    url: '/member/reviewinsert',
                    data: data,
                    success: function (result) {
                        Swal.fire({
                            title: "등록완료",
                            text: "후기가 등록되었습니다.",
                            icon: "success"
                        }).then((resolve) => {
                            console.log(result);
                            $('#writeReview').hide();
                            $('#completeReview').show();
                            location.reload();
                            // drawReview(result.review);

                        });

                    },
                    error: function () {

                    }
                })
            }

            function drawReview(data) {
                //리뷰입력 시 입력칸 바로 삭제
                let reviewlist = document.getElementById('reviewlist');

                let div = document.createElement('div');
                div.setAttribute("class", "rev");

                let h4 = document.createElement("h4");
                h4.innerText = '작성자 : ' + nickname;
                div.appendChild(h4);

                let div2 = document.createElement('div');
                div2.setAttribute("id", "stars_" + data.reviewId);
                div2.setAttribute("class", "star_rating");

                for (let i = 0; i < data.star; i++) {
                    let span = document.createElement('span');
                    span.classList.add('star', 'on');
                    div2.appendChild(span);
                }
                div.appendChild(div2);

                let span = document.createElement('span');
                span.innerText = new Date();
                div.appendChild(span);

                let div3 = document.createElement('div');
                let h4_2 = document.createElement('h4');
                h4_2.setAttribute('id', 'reviewContent_' + data.reviewId);
                h4_2.style.display = 'inline';
                h4_2.innerText = data.contents;
                div3.appendChild(h4_2);

                let div4 = document.createElement('div');
                div4.setAttribute('id', 'updateInput_' + data.reviewId);
                div4.style.display = 'none';

                let input = document.createElement('input');
                input.setAttribute('type', 'text');
                input.setAttribute('value', data.contents);
                div4.appendChild(input);

                let button = document.createElement('button');
                button.classList.add('btn');
                button.innerText = '수정';
                button.setAttribute('onclick', "updateReview('" + data.reviewId + "', event)");
                div4.appendChild(button);

                div3.appendChild(div4);
                div.appendChild(div3);

                let button2 = document.createElement('button');
                button2.classList.add('btn');
                button2.innerText = '✔️';
                button2.setAttribute('onclick', "toggleUpdateMode('" + data.reviewId + "')");
                div.appendChild(button2);

                let button3 = document.createElement('button');
                button3.classList.add('btn');
                button3.innerText = '❌';
                button3.setAttribute('onclick', "deleteReview('" + data.reviewId + "')");
                div.appendChild(button3);

                reviewlist.appendChild(div);

                document.getElementById('writeContents').value = '';
            }

            function updateReview(id, event) {
                console.log('리뷰 아이디 : ' + id);

                let content = event.currentTarget.parentElement.children[0].value;
                console.log(document.getElementById('stars_' + id));

                let stars = document.querySelectorAll('.star_on > .on');
                let maxStar = 0;
                stars.forEach(function (star, idx) {
                    // console.log(star.getAttribute("value"));
                    if (maxStar < star.getAttribute("value")) {
                        maxStar = star.getAttribute("value");
                    }
                })

                //리뷰 내용업데이트
                console.log(content + '/ ' + maxStar);

                let data = { reviewId: id, star: maxStar, contents: content };
                $.ajax({
                    type: 'POST',
                    url: '/member/reviewUpdate',
                    data: data,
                    success: function (result) {
                        Swal.fire({
                            title: "수정완료",
                            text: "후기가 수정되었습니다.",
                            icon: "success"
                        }).then((resolve) => {
                            console.log(result);
                            toggleUpdateMode(id);
                            document.getElementById('reviewContent_' + id).innerText = content;

                        });

                    },
                    error: function () {

                    }
                })


            }

            function deleteReview(id) {
                console.log(id + '번 삭제')

                Swal.fire({
                    title: "후기를 삭제하시겠습니까?",
                    text: "즉시 삭제가 진행됩니다.",
                    icon: "question",
                    showCancelButton: true,
                    confirmButtonColor: "#3085d6",
                    cancelButtonColor: "#d33",
                    confirmButtonText: "Yes"
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch('/member/reviewDelete?reviewId=' + id)
                            .then(resolve => resolve.json())
                            .then(result => {
                                console.log(result);
                                if (result.result == 'success') {
                                    Swal.fire({
                                        title: "삭제완료",
                                        text: "삭제가 완료되었습니다.",
                                        icon: "success"
                                    }).then((resolve) => {
                                        location.href = '/member/club/clubReview?clubId=' + clubId;

                                    });
                                }
                                else {
                                    Swal.fire({
                                        title: "삭제실패",
                                        text: "오류발생",
                                        icon: "error"
                                    }).then((resolve) => {
                                        location.reload();

                                    });
                                }
                            });
                    }
                })

            }
        </script>
    </div>

</body>

</html>